# CI type:shell
# https://github.com/coolsnowwolf/lede
# base
# ubuntu 16.04 x64 
# sudo apt-get update 
# sudo apt-get install build-essential asciidoc binutils 
# bzip2 gawk gettext git libncurses5-dev libz-dev patch 
# unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion 
# flex uglifyjs git-core gcc-multilib p7zip p7zip-full 
# msmtp libssl-dev texinfo libglib2.0-dev
#
# git clone url
# /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild

stages:
  - base
  - ac58u

job_base:
  stage: base
  tags: 
  - shell
  script:
    ## clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
    - cd /home/gitlab-runner/lede
    - git pull
    # remove feeds and tmp
    #- cd /home/gitlab-runner/lede
    #- rm -rf ./tmp
    #- rm -rf ./feeds
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a
    
job_ac58u:
  stage: ac58u
  tags: 
  - shell
  script:
    - |
    - rm -f ./.config*
    - touch ./.config
    #
    # ========================固件定制部分========================
    # 
    # 
    # 如果不对本区块做出任何编辑, 则生成默认配置固件. 
    # 
    # 以下为定制化固件选项和说明:
    #
    #
    # 有些插件/选项是默认开启的, 如果想要关闭, 请参照以下示例进行编写:
    # 
    #          =========================================
    #         |  # 取消编译VMware镜像:                   |
    #         |  cat >> .config <<EOF                   |
    #         |  # CONFIG_VMDK_IMAGES is not set        |
    #         |  EOF                                    |
    #          =========================================
    #
    # 
    # 以下是一些提前准备好的一些插件选项.
    # 直接取消注释相应代码块即可应用. 不要取消注释代码块上的汉字说明.
    # 如果不需要代码块里的某一项配置, 只需要删除相应行.
    #
    # 如果需要其他插件, 请按照示例自行添加.
    # 注意, 只需添加依赖链顶端的包. 如果你需要插件 A, 同时 A 依赖 B, 即只需要添加 A.
    # 
    # 无论你想要对固件进行怎样的定制, 都需要且只需要修改 EOF 回环内的内容.
    # 
    # 编译x64固件:
    # cat >> .config <<EOF
    # CONFIG_TARGET_ipq40xx=y
    # CONFIG_TARGET_ipq40xx_DEVICE_asus_rt-ac58u=y
    # EOF
    # USB3.0支持:
    # cat >> .config <<EOF
    # CONFIG_PACKAGE_kmod-usb-ohci=y
    # CONFIG_PACKAGE_kmod-usb-ohci-pci=y
    # CONFIG_PACKAGE_kmod-usb2=y
    # CONFIG_PACKAGE_kmod-usb2-pci=y
    # CONFIG_PACKAGE_kmod-usb3=y
    # EOF
    # 常用LuCI插件选择:
    # cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-adbyby-plus=y
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks=y
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Server=y
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Socks=y
    # CONFIG_PACKAGE_luci-app-webadmin=y
    # CONFIG_PACKAGE_luci-app-wrtbwmon=y
    # EOF
    # LuCI主题:
    # cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-theme-argon=y
    # EOF
    # 常用软件包:
    # cat >> .config <<EOF
    # CONFIG_PACKAGE_curl=y
    # CONFIG_PACKAGE_htop=y
    # CONFIG_PACKAGE_nano=y
    # CONFIG_PACKAGE_screen=y
    # CONFIG_PACKAGE_tree=y
    # CONFIG_PACKAGE_vim-fuller=y
    # CONFIG_PACKAGE_wget=y
    # EOF
    # 取消编译VMware镜像以及镜像填充 (不要删除被缩进的注释符号):
    # cat >> .config <<EOF
    # # CONFIG_TARGET_IMAGES_PAD is not set
    # # CONFIG_VMDK_IMAGES is not set
    # EOF
    # 
    # ========================固件定制部分结束========================
    # 
    - sed -i 's/^[ \t]*//g' ./.config
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j1
    # build pass and save
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-ac58u
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin
    ## remove git file
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    - rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-ac58u"
    #expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []
