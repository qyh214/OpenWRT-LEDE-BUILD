# CI type:shell
# https://github.com/coolsnowwolf/lede
# CI ref:https://github.com/coolsnowwolf/lede/blob/master/.github/workflows/openwrt-ci.yml
# base
# ubuntu 20.04 x64 
# sudo apt-get update 
# sudo apt-get install build-essential asciidoc binutils 
# bzip2 gawk gettext git libncurses5-dev libz-dev patch 
# unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion 
# flex uglifyjs git-core gcc-multilib p7zip p7zip-full 
# msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils 
# upx libelf-dev autoconf automake libtool autopoint 
# device-tree-compiler
#
# git clone url
# /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
#
# è´¡çŒ®è€…ã€æœ¬ä»“åº“ä½¿ç”¨è€…æ³¨æ„ï¼š
# åŸåˆ™ä¸Šï¼Œæœ¬ç¨‹åºä»…ç”¨äºå±é»„æœ¬äººå’Œå…¶æœ‹å‹ä½¿ç”¨ï¼Œå¦‚ä½ forkæœ¬é¡¹ç›®å¹¶åœ¨æœ¬ç½‘ç«™ä¸Šé€šè¿‡
# CIç¼–è¯‘ï¼Œå°†ä¼šå…±äº«åŸledeä»“åº“ï¼Œå¹¶éçº¯å‡€çš„dockeræ¨¡å¼ï¼Œå»ºè®®ä½¿ç”¨githubçš„action
# åŠŸèƒ½ï¼Œå®æ–½çº¯å‡€ç¼–è¯‘ä»¥åŠæ»¡è¶³æ›´å¤šçš„ä¸ªæ€§åŒ–æ“ä½œã€‚
#
# å¦‚æœä½ è¦å€ŸåŠ©åœ¨gitlabæœ¬åœ°è¿›è¡Œç¼–è¯‘ï¼Œè¯·éµå®ˆä»¥ä¸‹çº¦å®šï¼š
# è¯·å‹¿ä¿®æ”¹job_baseå†…å®¹ï¼Œå³ä¸è¦éšæ„å¯ç”¨ä»»ä½•çš„mkdirã€rmæ“ä½œï¼›
# éœ€è¦é¢å¤–è¯·æ±‚githubæ“ä½œåº”å½“å‘issueã€prç»™æœ¬ä¸Šæ¸¸ä»“åº“ï¼›
# ä½ åªèƒ½ä¸ªæ€§åŒ–job_æœºå‹é‡Œçš„â€œå›ºä»¶å®šåˆ¶éƒ¨åˆ†è‡³å›ºä»¶å®šåˆ¶éƒ¨åˆ†ç»“æŸâ€çš„å†…å®¹ï¼›
# 
# æ‰€æœ‰çš„/home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/ä¸­çš„shihuang
# æ”¹ä¸ºä½ çš„ç”¨æˆ·åï¼Œä¾‹å¦‚/home/gitlab-runner/builds/b5d89257/0/zhangsan/routerbuild/bin/
#
# å†æ¬¡é‡ç”³ï¼š
# ç¦æ­¢åœ¨ä»»ä½•é˜¶æ®µå¯¹ledeä»“åº“åšrmã€mkdirç­‰æ“ä½œï¼Œå¦‚æœ‰éœ€è¦è¯·prã€issue
#
# Github Actionï¼ŒèŒƒä¾‹å¯è§ï¼š
# https://github.com/ClayMoreBoy/lede/actions
# https://github.com/ClayMoreBoy/OpenWrt-Actions-R7800
#
# æœ‰å…³æ–‡æ¡£ï¼š
# https://github.com/coolsnowwolf/lede/pull/2198
#
# ledeä»“åº“å·²åŒ…å«å¯¹github actionçš„æ”¯æŒä»¥åŠç¤ºä¾‹ä»£ç 
#
# ä½¿ç”¨æœ¬åœ°ä»“åº“çš„CIè¿›è¡Œæœ‰é™çš„ä¸ªæ€§åŒ–å¯å‚è€ƒï¼šwendy03/routerbuild
#
# æœ¬ä»“åº“ä¸­archiveæ–‡ä»¶å¤¹é‡Œçš„é…ç½®æ–‡ä»¶ä¸ºè€æ—§æ–‡ä»¶ï¼Œä»…ä¾›å‚è€ƒï¼Œè¯·å‹¿ç›´æ¥cpåˆ°ledeä¸‹
#

stages:
  - base
  - r4s
  
job_base:
  stage: base
  tags: 
  - shell
  except:
  - tags
  script:
    ## ä¸‹æ¸¸åˆ†æ”¯ä»“åº“ä¸å¾—ä¿®æ”¹baseï¼Œå¦‚æœ‰éœ€è¦è¯·å‘èµ·prã€issue
    # clean build
    - cd /home/gitlab-runner/
    - if [ ! -d "/lede/" ];then rm -R lede; else git clone https://github.com/coolsnowwolf/lede.git; fi
    #- git clone https://github.com/coolsnowwolf/lede.git
    - cd /home/gitlab-runner/lede
    ## update code
    #- cd /home/gitlab-runner/lede
    #- git pull
    #- rm -rf ./tmp
    # remove feeds dl tmp
    #- cd /home/gitlab-runner/lede
    #- rm -rf ./tmp
    #- rm -rf ./feeds
    #- rm -rf ./dl
    ## extra package&git
    # ç¬¬äºŒæ¬¡ç¼–è¯‘å¼€å§‹è¯·æ³¨é‡Šæ‰ä»¥ä¸‹å†…å®¹
    #- cd /home/gitlab-runner/lede/package
    #- cd mkdir openwrt-packages
    #- rm -rf ./openwrt-packages
    # ä¸»é¢˜git
    #- git clone https://github.com/openwrt-develop/luci-theme-atmaterial.git
    #- cd /home/gitlab-runner/lede/package/luci-theme-atmaterial
    #- git pull
    #- git clone https://github.com/rosywrt/luci-theme-rosy.git
    #- cd /home/gitlab-runner/lede/package/luci-theme-rosy
    #- git pull
    #- cd /home/gitlab-runner/lede
    #- rm -rf ./tmp
    #- sed -i '9s/#src-git/src-git/g' ./feeds.conf.default
    ## æ·»åŠ helloworldæº
    - sed -i '$a\src-git helloworld https://github.com/fw876/helloworld' ./feeds.conf.default
    ## extra
    #- sed -i "/helloworld/d" "feeds.conf.default"
    #- echo "src-git helloworld https://github.com/fw876/helloworld.git" >> "feeds.conf.default"
    # æ·»åŠ å…¶ä»–æº
    # openclash
    #- sed -i '$a\src-git openclash https://github.com/vernesong/OpenClash' ./feeds.conf.default
    #- ./scripts/feeds clean
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a
    # Make clean
    #- make clean
    ## extra modify
    ## ç±»ä¼¼ï¼šhttps://github.com/msylgj/R2S-R4S-OpenWrt/blob/21.02/SCRIPTS/prepare_package.sh
    ## https://github.com/klever1988/nanopi-openwrt/blob/master/scripts/patches.sh
    ### ä¿®æ”¹é»˜è®¤wançš„ipåœ°å€ä¸º192.168.2.1
    - sed -i 's/192.168.1.1/192.168.2.1/g' package/base-files/files/bin/config_generate
    # set default theme to argon
    - sed -i '/uci commit luci/i\uci set luci.main.mediaurlbase="/luci-static/argon"' `find package -type f -path '*/default-settings/files/zzz-default-settings'`

job_r4s:
  stage: r4s
  tags: 
  - shell
  except:
  - tags
  script: |
    cd /home/gitlab-runner/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================å›ºä»¶å®šåˆ¶éƒ¨åˆ†========================
    # 
    # ç¼–è¯‘r4så›ºä»¶:
    cat >> .config <<EOF
    CONFIG_TARGET_rockchip=y
    CONFIG_TARGET_rockchip_armv8=y
    CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r4s=y
    EOF
    # éƒ¨åˆ†é…ç½®ä¿®æ”¹ï¼š
    cat >> .config <<EOF
    CONFIG_TARGET_ROOTFS_TARGZ=y
    EOF
    # å¸¸ç”¨LuCIæ’ä»¶å’Œé¢å¤–åŒ…é€‰æ‹©:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-app-jd-dailybonus=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Kcptun=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_NaiveProxy=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Server=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Redsocks2=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Simple_Obfs=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray_Plugin=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray=y
    CONFIG_PACKAGE_luci-app-uugamebooster=y
    EOF
    # LuCIä¸»é¢˜:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-argon=y
    EOF
    # å–æ¶ˆç¼–è¯‘(ä¸è¦åˆ é™¤è¢«ç¼©è¿›çš„æ³¨é‡Šç¬¦å·):
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-adbyby-plus is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
    # CONFIG_PACKAGE_luci-app-unblockmusic is not set
    # CONFIG_UnblockNeteaseMusic_Go is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    # CONFIG_PACKAGE_luci-app-zerotier is not set
    EOF
    # 
    # ========================å›ºä»¶å®šåˆ¶éƒ¨åˆ†ç»“æŸ========================
    # 
    
    echo 'Generate configuration file'
    # å¯¹æ¯”é…ç½®æ–‡ä»¶ï¼š
    cd /home/gitlab-runner/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean
    
    echo 'Make download'
    make download -j1
    echo 'Compile firmware'
    echo -e "$(nproc) thread compile"
    make -j$(nproc) || make -j1
    
    echo 'Assemble artifact'
    # build pass and save
    ## config
    cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## friendlyarm_nanopi_r4s
    #cp /home/gitlab-runner/lede/bin/targets/rockchip/armv8/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz
    cp /home/gitlab-runner/lede/bin/targets/rockchip/armv8/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz
    ## remove git file
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    rm .gitignore
    # ä¸Šä¼ ä¸å‘å¸ƒ
    ## ä¸Šä¼ 
    ### ä¸Šä¼ åˆ°CowTransferå¥¶ç‰›å¿«ä¼ 
    echo 'Upload Firmware To CowTransfer'
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/transfer
    curl -sL https://git.io/file-transfer | bash -s beta
    ./transfer cow --block 2621440 -s -p 99 -t 15 --hash --no-progress /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin 2>&1 | tee cowtransfer.log
    #- echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
    #- echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
    #- echo $COWTRANSFER_URL
    export COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")
    echo $COWTRANSFER_URL
    ### ä¸Šä¼ åˆ°å…¶ä»–å¹³å°
    ### ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
    echo 'Upload Firmware To Qiniu'
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/qiniu
    #### https://devtools.qiniu.com/qshell-v2.6.2-linux-amd64.tar.gz
    chmod +x qshell
    ./qshell account $qAK $qSK qiniu --overwrite
    ##### squashfs-sysupgrade.img.gz
    ./qshell fput staticdownload openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz --overwrite
    ##### .config
    ./qshell fput staticdownload r4s.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config --overwrite
    # å‘å¸ƒrelease
    echo 'Release R4S'
    curl --header 'Content-Type: application/json' --header "PRIVATE-TOKEN: $user_token" --data '{ "name": "'"`date   +%Y%m%d`"'-R4S-'"$CI_JOB_ID"'-snapshot", "tag_name": "CI-'"$CI_JOB_ID"'", "ref": "'"$CI_COMMIT_BRANCH"'", "description": "è¯´æ˜ï¼š<br />é»˜è®¤åœ°å€ï¼š192.168.2.1<br />é»˜è®¤è´¦å·ï¼šroot<br />é»˜è®¤å¯†ç ï¼špassword<br />é»˜è®¤ä¸»é¢˜ï¼šargon<br /><br />*.img.gzæ ¼å¼æ–‡ä»¶ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è§£å‹ã€‚å¦‚æœä¸‹è½½çš„æ‰©å±•åæ˜¯*.zipéœ€è¦è§£å‹ï¼Œé‡Œé¢*.img.gzæ˜¯å›ºä»¶ã€‚<br />å°†å›ºä»¶*.img.gzä½¿ç”¨çƒ§å½•å·¥å…·çƒ§å½•æˆ–è€…åœ¨è·¯ç”±å™¨ç½‘é¡µç®¡ç†åå°ç›´æ¥ä¸Šä¼ å‡çº§ä½¿ç”¨<br />ç®¡ç†åå°å‡çº§ä»…é™äºä¹‹å‰æ›¾ç»ä½¿ç”¨åœ¨æœ¬å¤„ç¼–è¯‘çš„å›ºä»¶å¹¶ä¸”å¹¶éå¤§ç‰ˆæœ¬ä¹‹é—´æ›´æ–°ï¼Œå¤§ç‰ˆæœ¬æ›´æ–°å¯èƒ½ä¼šæ¸…é™¤æ‰€æœ‰é…ç½®ä¿¡æ¯æˆ–è€…è¯·ç›´æ¥çƒ§å½•é‡ç½®å…¨éƒ¨æ•°æ®ã€‚<br /><br />çƒ§å½•å·¥å…·ä¸‹è½½ï¼š<br />[balenaEtcher](https://www.balena.io/etcher/)<br /><br />å›ºä»¶ä¸‹è½½åœ°å€ï¼š<br />ğŸ”—[æœ¬åœ°ä¸‹è½½ï¼ˆå†…ç½‘ç”¨æˆ·ï¼‰](http://192.168.2.100:800/shihuang/routerbuild/-/jobs/'"$CI_JOB_ID"'/artifacts/download)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºç¼–è¯‘æˆåŠŸå6ä¸ªæœˆï¼Œä»…é™å†…ç½‘ç”¨æˆ·ä½¿ç”¨ï¼Œå¤–ç½‘ç”¨æˆ·å»ºè®®ä½¿ç”¨ä¸‹é¢çš„å…¶ä»–å¤–é“¾åœ°å€ä¸‹è½½ã€‚<br /><br />ğŸ”—[æœ¬åœ°ä¸‹è½½ï¼ˆå¤–ç½‘ç”¨æˆ·ï¼‰](http://git.qyh.name/shihuang/routerbuild/-/jobs/'"$CI_JOB_ID"'/artifacts/download)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºç¼–è¯‘æˆåŠŸå6ä¸ªæœˆï¼Œä¸‹è½½é™é€Ÿï¼Œå¯èƒ½ä¸‹è½½ç¼“æ…¢æˆ–å‡ºç°ä¸­æ–­ï¼Œä¸æ¨èå¤–ç½‘ç”¨æˆ·ä½¿ç”¨ï¼Œå¤–ç½‘ç”¨æˆ·å»ºè®®ä½¿ç”¨ä¸‹é¢çš„å…¶ä»–å¤–é“¾åœ°å€ä¸‹è½½ã€‚<br /><br /><br />ğŸ”—[Cowtransferå¥¶ç‰›å¿«ä¼ ]('"$COWTRANSFER_URL"')<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºç¼–è¯‘æˆåŠŸå1å¤©å†…ï¼Œæœ‰ä¸‹è½½æ¬¡æ•°é™åˆ¶ã€‚<br />ğŸ”—[ä¸ƒç‰›äº‘(å›ºä»¶)](http://down.cdn.qyh0214.com/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºé•¿æœŸï¼Œåœ¨æ¯æ¬¡ç¼–è¯‘æˆåŠŸåå³è¦†ç›–ä¸ºæ–°ç‰ˆæœ¬ã€‚<br />ğŸ”—[ä¸ƒç‰›äº‘(å›ºä»¶CIé…ç½®æ–‡ä»¶config)](http://down.cdn.qyh0214.com/r4s.config)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºé•¿æœŸï¼Œåœ¨æ¯æ¬¡ç¼–è¯‘æˆåŠŸåå³è¦†ç›–ä¸ºæ–°ç‰ˆæœ¬ã€‚æ­¤æ–‡ä»¶ä¸»è¦ç”¨äºå¼€å‘è€…ä½¿ç”¨ï¼Œä¸€èˆ¬æ— éœ€ä¸‹è½½ã€‚<br />"}' --request POST http://git.qyh.name/api/v4/projects/41/releases
 
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-r4s"
    expire_in: 6 months
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []
