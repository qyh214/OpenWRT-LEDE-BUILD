# gitlab-runner home
# todo:with lede updatetime to build
build_job:
  stage: build
  tags: 
  - shell
  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    - cd /home/gitlab-runner/lede
    # update code
    - git pull
    # fix patch ph
    - mv /home/gitlab-runner/lede/target/linux/ipq806x/patches-4.9/0069-arm-boot-add-dts-files.patch /home/gitlab-runner/lede/target/linux/ipq806x/patches-4.9/0069-arm-boot-add-dts-files.patch.backup
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/0069-arm-boot-add-dts-files.patch /home/gitlab-runner/lede/target/linux/ipq806x/patches-4.9/0069-arm-boot-add-dts-files.patch
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a 
    # config copy
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/.config /home/gitlab-runner/lede/.config
    #- make menuconfig(error)/make defconfig(compare with git)
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j4 V=s
    # build pass
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
    - mkdir bin
    # copy bin
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## R7800
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/lede-ipq806x-R7800-squashfs-factory.img /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-lede-ipq806x-R7800-squashfs-factory.img
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/lede-ipq806x-R7800-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-lede-ipq806x-R7800-squashfs-sysupgrade.tar
    ## RT-AC58U
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/lede-ipq806x-RT-AC58U-squashfs-flash-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-lede-ipq806x-RT-AC58U-squashfs-flash-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/lede-ipq806x-RT-AC58U-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-lede-ipq806x-RT-AC58U-squashfs-sysupgrade.tar
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-lede-router"
    expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin