image: shihuang214/openwrt_ubuntu:v1

stages:
  - build_r4s
  
build_r4s:
  stage: build_r4s
  tags: 
  - docker
  except:
  - tags
  before_script: 
    - apt-get update
    - DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata
    - apt-get install -y ack antlr3 aria2 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
    # gité¢„è®¾ç½®-CIä¸“ç”¨
    - git config --global user.email "CI@ci.com"
    - git config --global user.name "ci"
    # è·å–æœ€æ–°ledeæ•°æ®
    - cd /builds/shihuang/routerbuild
    # åªæ‹‰å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„masteråˆ†æ”¯çš„æºç 
    - git clone --branch "master" --single-branch --depth 1 https://github.com/coolsnowwolf/lede.git
    # è¿›å…¥ledeå¹¶æ·»åŠ openclash
    - cd /builds/shihuang/routerbuild/lede
    ## openclashä½¿ç”¨devåˆ†æ”¯åˆ°packageä¸‹
    - git clone --branch "dev" --single-branch --depth 1 https://github.com/vernesong/OpenClash.git package/openclash
    ## openclashå°†å‡ ä¸ªå†…æ ¸æœ€æ–°ç‰ˆç›´æ¥æ³¨å…¥æºç ä¸­ï¼Œä½¿ç”¨devåˆ†æ”¯
    - cd /builds/shihuang/routerbuild/lede/package/openclash/luci-app-openclash/root/etc/openclash
    - mkdir ./core && cd ./core
    - export TUN_VER=$(curl -s https://raw.githubusercontent.com/vernesong/OpenClash/core/dev/core_version | sed -n '2p')
    - echo $TUN_VER
    - curl -SsL -o ./tun.gz https://github.com/vernesong/OpenClash/raw/core/dev/premium/clash-linux-arm64-$TUN_VER.gz
    - gzip -d ./tun.gz
    - mv ./tun ./clash_tun
    - curl -SsL -o ./meta.tar.gz https://github.com/vernesong/OpenClash/raw/core/dev/meta/clash-linux-arm64.tar.gz
    - tar -zxf ./meta.tar.gz
    - mv ./clash ./clash_meta
    - curl -SsL -o ./dev.tar.gz https://github.com/vernesong/OpenClash/raw/core/dev/dev/clash-linux-arm64.tar.gz
    - tar -zxf ./dev.tar.gz
    - chmod +x ./clash*
    - rm -rf ./*.gz
    # æ·»åŠ ä¸»é¢˜ Designåˆ°packageä¸‹ï¼ˆmainåˆ†æ”¯æ˜¯luaï¼Œé€‚ç”¨äºledeï¼Œopenwrt21é‡‡ç”¨jsï¼Œéœ€è¦ç”¨jsåˆ†æ”¯ï¼‰
    - cd /builds/shihuang/routerbuild/lede
    - git clone --branch "main" --single-branch --depth 1 https://github.com/gngpp/luci-theme-design.git package/luci-theme-design
    # æ·»åŠ ä¸»é¢˜ Design Configåˆ°packageä¸‹
    - git clone --branch "master" --single-branch --depth 1 https://github.com/gngpp/luci-app-design-config.git package/luci-app-design-config
    # åˆå¹¶ä»£ç 
    - cd /builds/shihuang/routerbuild/lede
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a
    # é¢å¤–æ”¹åŠ¨
    ## å‚è€ƒï¼š
    ## - https://github.com/msylgj/R2S-R4S-OpenWrt/blob/21.02/SCRIPTS/prepare_package.sh
    ## - https://github.com/klever1988/nanopi-openwrt/blob/master/scripts/patches.sh
    ## ä¿®æ”¹é»˜è®¤wançš„ipåœ°å€ä¸º192.168.2.1
    - sed -i 's/192.168.1.1/192.168.2.1/g' package/base-files/files/bin/config_generate
    ## ä¿®æ”¹é»˜è®¤ä¸»é¢˜ä¸ºdesignï¼ˆå¿…é¡»é€‰æ‹©è¿™ä¸ªä¸»é¢˜å®‰è£…ï¼‰
    - sed -i 's/luci-theme-bootstrap/luci-theme-design/' feeds/luci/collections/luci/Makefile

  script: |
    echo 'clean config'
    cd /builds/shihuang/routerbuild/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================å›ºä»¶å®šåˆ¶éƒ¨åˆ†========================
    # å‚è€ƒï¼šhttps://github.com/DHDAXCW/NanoPi-R4S-R4SE/blob/main/configs/lean/lean.config
    # https://doc.openwrt.cc/1-General/4-Firmware-Format/
    # 
    # TODOï¼šéœ€è¦é‡å»ºå›ºä»¶ï¼Œtodo-å¯èƒ½æ”¹ä¸ºext4ç‰ˆæœ¬
    ## CONFIG_TARGET_KERNEL_PARTSIZE=256 - å†…æ ¸åŒºä¸éœ€è¦æ”¹
    # CONFIG_TARGET_ROOTFS_PARTSIZE=1024
    # ç¼–è¯‘r4så›ºä»¶:
    cat >> .config <<EOF
    CONFIG_TARGET_rockchip=y
    CONFIG_TARGET_rockchip_armv8=y
    CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r4s=y
    EOF
    # éƒ¨åˆ†é…ç½®ä¿®æ”¹ï¼š
    cat >> .config <<EOF
    CONFIG_TARGET_ROOTFS_TARGZ=y
    CONFIG_TARGET_ROOTFS_SQUASHFS=y
    EOF
    # å¸¸ç”¨LuCIæ’ä»¶å’Œé¢å¤–åŒ…é€‰æ‹©:
    cat >> .config <<EOF
    CONFIG_PACKAGE_ipv6helper=y
    ##CONFIG_PACKAGE_ip6tables-extra=y
    ##CONFIG_PACKAGE_ip6tables-mod-nat=y
    CONFIG_PACKAGE_luci-app-diskman=y
    CONFIG_PACKAGE_luci-app-openclash=y
    CONFIG_PACKAGE_luci-app-uugamebooster=y
    CONFIG_PACKAGE_luci-app-wrtbwmon=y
    CONFIG_PACKAGE_luci-app-ttyd=y
    EOF
    # LuCIä¸»é¢˜:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-design=y
    CONFIG_PACKAGE_luci-app-design-config=y
    EOF
    # å–æ¶ˆç¼–è¯‘(ä¸è¦åˆ é™¤è¢«ç¼©è¿›çš„æ³¨é‡Šç¬¦å·): 
    # ä¾æ®ï¼šCONFIG_DEFAULT_luci-app-xxx
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    EOF
    # 
    # ========================å›ºä»¶å®šåˆ¶éƒ¨åˆ†ç»“æŸ========================
    # 
    
    echo 'Generate configuration file'
    # å¯¹æ¯”é…ç½®æ–‡ä»¶ï¼š
    cd /builds/shihuang/routerbuild/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean
    
    echo 'Make download'
    #echo -e "$(nproc) thread download"
    #make download -j$(nproc) || make download -j1
    make download -j4
    echo 'Compile firmware'
    #echo -e "$(nproc) thread compile"
    # è®¾ç½®ä¸ºérootç”¨æˆ·ç¼–è¯‘FORCE_UNSAFE_CONFIGURE=1
    #make FORCE_UNSAFE_CONFIGURE=1 -j$(nproc) || make -j1
    make FORCE_UNSAFE_CONFIGURE=1 -j4
    # ä¿å­˜ç¼–è¯‘åå›ºä»¶ï¼ˆç¼–è¯‘åæ–‡ä»¶æ”¾ç½®åœ¨binç›®å½•ä¸‹ï¼‰
    echo 'Assemble artifact'
    # è®¾ç½®æ—¶é—´æ ‡å·
    export BuildDate="`date   +%Y%m%d`"
    echo $BuildDate
    ## config
    cp /builds/shihuang/routerbuild/lede/.config /builds/shihuang/routerbuild/bin/.config
    ## friendlyarm_nanopi_r4s
    #cp /builds/shihuang/routerbuild/lede/bin/targets/rockchip/armv8/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz /builds/shihuang/routerbuild/bin/$BuildDate-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz
    cp /builds/shihuang/routerbuild/lede/bin/targets/rockchip/armv8/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz /builds/shihuang/routerbuild/bin/$BuildDate-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz
    ## remove git file
    cd /builds/shihuang/routerbuild/bin
    rm .gitignore
    # ä¸Šä¼ ä¸å‘å¸ƒ
    ## ä¸Šä¼ 
    ### ä¸Šä¼ åˆ°CowTransferå¥¶ç‰›å¿«ä¼ 
    ### echo 'Upload Firmware To CowTransfer'
    ### cd /builds/shihuang/routerbuild/transfer
    ### curl -sL https://git.io/file-transfer | bash -s beta
    ### ./transfer cow --block 2621440 -s -p 99 -t 15 --hash --no-progress /builds/shihuang/routerbuild/bin 2>&1 | tee cowtransfer.log
    ####- echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
    ####- echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
    ####- echo $COWTRANSFER_URL
    ###export COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")
    ###echo $COWTRANSFER_URL
    ### ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
    echo 'Upload Firmware To Qiniu'
    cd /builds/shihuang/routerbuild/qiniu
    #### https://devtools.qiniu.com/qshell-v2.6.2-linux-amd64.tar.gz
    chmod +x qshell
    ./qshell account $qAK $qSK qiniu --overwrite
    ##### squashfs-sysupgrade.img.gz
    ./qshell fput staticdownload openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz /builds/shihuang/routerbuild/bin/$BuildDate-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz --overwrite
    ##### ext4-sysupgrade.img.gz
    #./qshell fput staticdownload openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz /builds/shihuang/routerbuild/bin/$BuildDate-$CI_JOB_ID-openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-ext4-sysupgrade.img.gz --overwrite
    ##### .config
    ./qshell fput staticdownload r4s.config /builds/shihuang/routerbuild/bin/.config --overwrite
    # å‘å¸ƒrelease
    echo 'Release R4S'
    curl --header 'Content-Type: application/json' --header "PRIVATE-TOKEN: $user_token" --data '{ "name": "'"$BuildDate"'-R4S-'"$CI_JOB_ID"'-snapshot", "tag_name": "CI-'"$CI_JOB_ID"'", "ref": "'"$CI_COMMIT_BRANCH"'", "description": "è¯´æ˜ï¼š<br />å›ºä»¶ä»‹ç»é¡µé¢ï¼š[https://www.qyh.name/807/](https://www.qyh.name/807/)<br />é»˜è®¤ç®¡ç†åœ°å€ï¼š192.168.2.1<br />é»˜è®¤è´¦å·ï¼šroot<br />é»˜è®¤å¯†ç ï¼špassword<br />é»˜è®¤ä¸»é¢˜ï¼šdesign<br />å½“å‰å†…æ ¸åˆ†åŒºï¼š32MB<br />å½“å‰ç³»ç»Ÿåˆ†åŒºï¼š160MB<br /><br />img.gzæ ¼å¼æ–‡ä»¶ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è§£å‹ã€‚<br />å°†å›ºä»¶img.gzä½¿ç”¨çƒ§å½•å·¥å…·çƒ§å½•æˆ–è€…åœ¨è·¯ç”±å™¨ç½‘é¡µç®¡ç†åå°ç›´æ¥ä¸Šä¼ å‡çº§ä½¿ç”¨ï¼›<br />ç®¡ç†åå°å‡çº§ä»…é™äºä¹‹å‰æ›¾ç»ä½¿ç”¨åœ¨æœ¬å¤„ç¼–è¯‘çš„å›ºä»¶å¹¶ä¸”å¹¶éå¤§ç‰ˆæœ¬ä¹‹é—´æ›´æ–°ï¼Œå¤§ç‰ˆæœ¬æ›´æ–°å¯èƒ½ä¼šæ¸…é™¤æ‰€æœ‰é…ç½®ä¿¡æ¯æˆ–è€…è¯·ç›´æ¥çƒ§å½•é‡ç½®å…¨éƒ¨æ•°æ®ã€‚<br />è¯·æ³¨æ„å›ºä»¶çš„æ ¼å¼å’Œåˆ†åŒºå¤§å°ï¼Œè‹¥æœ‰ä¸åŒè¯·å‹¿æ··åˆä½¿ç”¨å’Œæ›´æ–°ã€‚<br /><br />çƒ§å½•å·¥å…·ä¸‹è½½ï¼š<br />[balenaEtcher](https://www.balena.io/etcher/)<br /><br />å›ºä»¶ä¸‹è½½åœ°å€ï¼š<br />ğŸ”—[æœ¬åœ°ä¸‹è½½ï¼ˆä»…é™å±€åŸŸç½‘å†…ç½‘ç”¨æˆ·ï¼‰](http://192.168.2.100:800/shihuang/routerbuild/-/jobs/'"$CI_JOB_ID"'/artifacts/download)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºç¼–è¯‘æˆåŠŸå6ä¸ªæœˆã€‚<br /><br />ğŸ”—[ä¸ƒç‰›äº‘(å¤–ç½‘ç”¨æˆ·ï¼Œsquashfså›ºä»¶)](http://down.cdn.qyh0214.com/openwrt-rockchip-armv8-friendlyarm_nanopi-r4s-squashfs-sysupgrade.img.gz)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºé•¿æœŸï¼Œåœ¨æ¯æ¬¡ç¼–è¯‘æˆåŠŸåå³è¦†ç›–ä¸ºæ–°ç‰ˆæœ¬ã€‚<br />ğŸ”—[ä¸ƒç‰›äº‘(å¤–ç½‘ç”¨æˆ·ï¼Œå›ºä»¶é…ç½®æ–‡ä»¶)](http://down.cdn.qyh0214.com/r4s.config)<br />ã€è¯´æ˜ã€‘é“¾æ¥æœ‰æ•ˆæœŸä¸ºé•¿æœŸï¼Œåœ¨æ¯æ¬¡ç¼–è¯‘æˆåŠŸåå³è¦†ç›–ä¸ºæ–°ç‰ˆæœ¬ã€‚æ­¤æ–‡ä»¶ä¸»è¦ç”¨äºå¼€å‘è€…ä½¿ç”¨ï¼Œä¸€èˆ¬æ— éœ€ä¸‹è½½ã€‚<br />"}' --request POST http://192.168.2.100:800/api/v4/projects/41/releases
 
  artifacts:
    #`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-r4s
    name: "$CI_JOB_ID-openwrt-router-r4s"
    expire_in: 6 months
    paths:
      - /builds/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []
