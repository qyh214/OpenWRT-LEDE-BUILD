# CI type:shell
# https://github.com/coolsnowwolf/lede
# base
# ubuntu 16.04 x64 
# sudo apt-get update 
# sudo apt-get install build-essential asciidoc binutils 
# bzip2 gawk gettext git libncurses5-dev libz-dev patch 
# unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion 
# flex uglifyjs git-core gcc-multilib p7zip p7zip-full 
# msmtp libssl-dev texinfo libglib2.0-dev
#
# git clone url
# /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild

stages:
  - base
  - ac58u
  - acrh17
  - r7800
  - test

job_base:
  stage: base
  tags: 
  - shell
  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
    - cd /home/gitlab-runner/lede
    # due to lean
    #- git reset --hard 00209c9
    #- cd /home/gitlab-runner/lede/package
    #- rm -rf ./openwrt-packages
    #- cp -r package openwrt-packages
    #- mv openwrt-packages package
    - git pull
    #- cd /home/gitlab-runner/lede
    #- rm -rf ./tmp
    #- rm -rf ./feeds
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a
    
job_ac58u:
  stage: ac58u
  tags: 
  - shell
  script:
    # config copy
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/ac58u.config /home/gitlab-runner/lede/.config
    - cd /home/gitlab-runner/lede
    #- make menuconfig(error)/make defconfig(compare with git)
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j1
    # build pass and save
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-ac58u
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin
    ## remove git file
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    - rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-ac58u"
    #expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []

job_acrh17:
  stage: acrh17
  tags: 
  - shell
  script:
    # config copy
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/acrh17.config /home/gitlab-runner/lede/.config
    - cd /home/gitlab-runner/lede
    #- make menuconfig(error)/make defconfig(compare with git)
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j1
    # build pass and save
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-acrh17
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-initramfs-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-acrh17-initramfs-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.bin
    ## remove git file
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    - rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-acrh17"
    #expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []

job_r7800:
  stage: r7800
  tags: 
  - shell
  script:
    # config copy
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/r7800.config /home/gitlab-runner/lede/.config
    - cd /home/gitlab-runner/lede
    #- make menuconfig(error)/make defconfig(compare with git)
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j1
    # build pass and save
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## netgear_r7800
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-factory.img /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-factory.img
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin
    ## remove git file
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    - rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-r7800"
    #expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []

job_test:
  stage: test
  tags: 
  - shell
  script:
    # test file status
    ## ipq40xx
    - cd /home/gitlab-runner/lede/bin/targets/ipq40xx/generic
    ### asus_rt-ac58u
    - stat openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx
    - stat openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin
    ### asus_rt-acrh17
    - stat openwrt-ipq40xx-asus_rt-acrh17-initramfs-factory.trx
    - stat openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.bin
    ## ipq806x
    - cd /home/gitlab-runner/lede/bin/targets/ipq806x/generic
    ### netgear_r7800
    - stat openwrt-ipq806x-netgear_r7800-squashfs-factory.img
    - stat openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin
  # disable artifact passing
  dependencies: []
