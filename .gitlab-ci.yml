# CI type:shell
# https://github.com/coolsnowwolf/lede
# CI ref:https://github.com/coolsnowwolf/lede/blob/master/.github/workflows/openwrt-ci.yml
# base
# ubuntu 16.04 x64 
# sudo apt-get update 
# sudo apt-get install build-essential asciidoc binutils 
# bzip2 gawk gettext git libncurses5-dev libz-dev patch 
# unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion 
# flex uglifyjs git-core gcc-multilib p7zip p7zip-full 
# msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils 
# upx libelf-dev autoconf automake libtool autopoint 
# device-tree-compiler
#
# git clone url
# /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
#
# 贡献者、本仓库使用者注意：
# 原则上，本程序仅用于屎黄本人和其朋友使用，如你fork本项目并在本网站上通过
# CI编译，将会共享原lede仓库，并非纯净的docker模式，建议使用github的action
# 功能，实施纯净编译以及满足更多的个性化操作。
#
# 如果你要借助在gitlab本地进行编译，请遵守以下约定：
# 请勿修改job_base内容，即不要随意启用任何的mkdir、rm操作；
# 需要额外请求github操作应当发issue、pr给本上游仓库；
# 你只能个性化job_机型里的“固件定制部分至固件定制部分结束”的内容；
# 
# 所有的/home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/中的shihuang
# 改为你的用户名，例如/home/gitlab-runner/builds/b5d89257/0/zhangsan/routerbuild/bin/
#
# 再次重申：
# 禁止在任何阶段对lede仓库做rm、mkdir等操作，如有需要请pr、issue
#
# Github Action，范例可见：
# https://github.com/ClayMoreBoy/lede/actions
# 有关文档：
# https://github.com/coolsnowwolf/lede/pull/2198
#
# lede仓库已包含对github action的支持以及示例代码
#
# 使用本地仓库的CI进行有限的个性化可参考：wendy03/routerbuild
#
# 本仓库中archive文件夹里的配置文件为老旧文件，仅供参考，请勿直接cp到lede下
#

stages:
  - base
  - ac58u
  - acrh17
  - r7800
  - k3

job_base:
  stage: base
  tags: 
  - shell
  script:
    ## 下游分支仓库不得修改base，如有需要请发起pr、issue
    ## clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
    - cd /home/gitlab-runner/lede
    - git pull
    #- rm -rf ./tmp
    # remove feeds dl tmp
    #- cd /home/gitlab-runner/lede
    #- rm -rf ./tmp
    #- rm -rf ./feeds
    #- rm -rf ./dl
    ## extra package&git
    # 第二次编译开始请注释掉以下内容
    #- cd /home/gitlab-runner/lede/package
    #- cd mkdir openwrt-packages
    #- rm -rf ./openwrt-packages
    # 主题git
    #- git clone https://github.com/openwrt-develop/luci-theme-atmaterial.git
    #- cd /home/gitlab-runner/lede/package/luci-theme-atmaterial
    #- git pull
    #- git clone https://github.com/rosywrt/luci-theme-rosy.git
    #- cd /home/gitlab-runner/lede/package/luci-theme-rosy
    #- git pull
    #- cd /home/gitlab-runner/lede
    - sed -i 's/\"#src-git\"/\"src-git\"/g' ./feeds.conf.default
    #- ./scripts/feeds clean
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a
    # Make clean
    - make clean
    
job_ac58u:
  stage: ac58u
  tags: 
  - shell
  script: |
    cd /home/gitlab-runner/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================固件定制部分========================
    #
    # 编译ac58u固件:
    cat >> .config <<EOF
    CONFIG_TARGET_ipq40xx=y
    CONFIG_TARGET_ipq40xx_DEVICE_asus_rt-ac58u=y
    EOF
    # 常用LuCI插件选择:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-app-ssr-plus=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks=y
    CONFIG_PACKAGE_luci-app-guest-wifi=y
    CONFIG_PACKAGE_luci-i18n-guest-wifi-zh-cn=y
    EOF
    # LuCI主题:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-argon=y
    CONFIG_PACKAGE_luci-theme-bootstrap=y
    CONFIG_PACKAGE_luci-theme-material=y
    EOF
    # 取消编译(不要删除被缩进的注释符号):
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
    # CONFIG_PACKAGE_luci-app-pptp-server is not set
    # CONFIG_PACKAGE_luci-app-qbittorrent is not set
    # CONFIG_PACKAGE_luci-app-unblockmusic is not set
    # CONFIG_PACKAGE_luci-app-unblockneteasemusic-mini is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    # CONFIG_PACKAGE_luci-app-xlnetacc is not set
    # CONFIG_PACKAGE_luci-app-zerotier is not set
    # CONFIG_PACKAGE_luci-app-shadowsocks-libev is not set
    # CONFIG_PACKAGE_luci-app-v2ray-server is not set
    # CONFIG_UnblockNeteaseMusic_Go is not set
    # CONFIG_UnblockNeteaseMusic_NodeJS is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray_plugin is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan is not set
    # CONFIG_PACKAGE_luci-app-music-remote-center is not set
    EOF
    # 
    # ========================固件定制部分结束========================
    # 
    
    echo 'Generate configuration file'
    # 对比配置文件：
    cd /home/gitlab-runner/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean
    
    echo 'Make download'
    make download -j1
    echo 'Compile firmware'
    make -j1
    
    echo 'Assemble artifact'
    # build pass and save
    ## config
    ## 下游分支修改shihuang为你的用户名
    cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-ac58u
    cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-initramfs-factory.trx
    cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.bin
    ## remove git file
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-ac58u"
    expire_in: 6 months
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []
  
job_acrh17:
  stage: acrh17
  tags: 
  - shell
  script: |
    cd /home/gitlab-runner/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================固件定制部分========================
    # 
    # 编译acrh17固件:
    cat >> .config <<EOF
    CONFIG_TARGET_ipq40xx=y
    CONFIG_TARGET_ipq40xx_DEVICE_asus_rt-acrh17=y
    EOF
    # 常用LuCI插件选择:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-app-ssr-plus=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks=y
    CONFIG_PACKAGE_luci-app-guest-wifi=y
    CONFIG_PACKAGE_luci-i18n-guest-wifi-zh-cn=y
    EOF
    # LuCI主题:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-argon=y
    CONFIG_PACKAGE_luci-theme-bootstrap=y
    CONFIG_PACKAGE_luci-theme-material=y
    EOF
    # 取消编译(不要删除被缩进的注释符号):
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
    # CONFIG_PACKAGE_luci-app-pptp-server is not set
    # CONFIG_PACKAGE_luci-app-qbittorrent is not set
    # CONFIG_PACKAGE_luci-app-unblockmusic is not set
    # CONFIG_PACKAGE_luci-app-unblockneteasemusic-mini is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    # CONFIG_PACKAGE_luci-app-xlnetacc is not set
    # CONFIG_PACKAGE_luci-app-zerotier is not set
    # CONFIG_PACKAGE_luci-app-shadowsocks-libev is not set
    # CONFIG_PACKAGE_luci-app-v2ray-server is not set
    # CONFIG_UnblockNeteaseMusic_Go is not set
    # CONFIG_UnblockNeteaseMusic_NodeJS is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray_plugin is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan is not set
    # CONFIG_PACKAGE_luci-app-music-remote-center is not set
    EOF
    # 
    # ========================固件定制部分结束========================
    # 
    
    echo 'Generate configuration file'
    # 对比配置文件：
    cd /home/gitlab-runner/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean

    echo 'Make download'
    make download -j1
    echo 'Compile firmware'
    make -j1
    
    echo 'Assemble artifact'
    # build pass and save
    ## config
    cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-acrh17
    cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-initramfs-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-acrh17-initramfs-factory.trx
    cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.bin
    ## remove git file
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-acrh17"
    expire_in: 6 months
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []

job_r7800:
  stage: r7800
  tags: 
  - shell
  script: |
    cd /home/gitlab-runner/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================固件定制部分========================
    # 
    # 编译r7800固件:
    cat >> .config <<EOF
    CONFIG_TARGET_ipq806x=y
    CONFIG_TARGET_ipq806x_DEVICE_netgear_r7800=y
    EOF
    # 常用LuCI插件选择:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-app-ssr-plus=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks=y
    CONFIG_PACKAGE_luci-app-guest-wifi=y
    CONFIG_PACKAGE_luci-i18n-guest-wifi-zh-cn=y
    EOF
    # LuCI主题:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-argon=y
    CONFIG_PACKAGE_luci-theme-bootstrap=y
    CONFIG_PACKAGE_luci-theme-material=y
    EOF
    # 取消编译(不要删除被缩进的注释符号):
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
    # CONFIG_PACKAGE_luci-app-pptp-server is not set
    # CONFIG_PACKAGE_luci-app-qbittorrent is not set
    # CONFIG_PACKAGE_luci-app-unblockmusic is not set
    # CONFIG_PACKAGE_luci-app-unblockneteasemusic-mini is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    # CONFIG_PACKAGE_luci-app-xlnetacc is not set
    # CONFIG_PACKAGE_luci-app-zerotier is not set
    # CONFIG_PACKAGE_luci-app-shadowsocks-libev is not set
    # CONFIG_PACKAGE_luci-app-v2ray-server is not set
    # CONFIG_UnblockNeteaseMusic_Go is not set
    # CONFIG_UnblockNeteaseMusic_NodeJS is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray_plugin is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan is not set
    # CONFIG_PACKAGE_luci-app-music-remote-center is not set
    EOF
    # 
    # ========================固件定制部分结束========================
    # 
    
    echo 'Generate configuration file'
    # 对比配置文件：
    cd /home/gitlab-runner/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean
    
    echo 'Make download'
    make download -j1
    echo 'Compile firmware'
    make -j1
    
    echo 'Assemble artifact'
    # build pass and save
    ## config
    cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## netgear_r7800
    cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-factory.img /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-factory.img
    cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin
    ## remove git file
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-r7800"
    expire_in: 6 months
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []

job_k3:
  stage: k3
  tags: 
  - shell
  script: |
    cd /home/gitlab-runner/lede
    rm -f ./.config*
    touch ./.config
    
    echo 'Custom configure file'
    #
    # ========================固件定制部分========================
    # 
    # 编译k3固件:
    cat >> .config <<EOF
    CONFIG_TARGET_bcm53xx=y
    CONFIG_TARGET_bcm53xx_DEVICE_phicomm-k3=y
    EOF
    # 常用LuCI插件选择:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-app-ssr-plus=y
    CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks=y
    CONFIG_PACKAGE_luci-app-guest-wifi=y
    CONFIG_PACKAGE_luci-i18n-guest-wifi-zh-cn=y
    EOF
    # LuCI主题:
    cat >> .config <<EOF
    CONFIG_PACKAGE_luci-theme-argon=y
    CONFIG_PACKAGE_luci-theme-bootstrap=y
    CONFIG_PACKAGE_luci-theme-material=y
    EOF
    # k3 Extra packages：
    cat >> .config <<EOF
    CONFIG_PACKAGE_automount=y
    CONFIG_PACKAGE_autosamba=y
    EOF
    # 取消编译(不要删除被缩进的注释符号):
    cat >> .config <<EOF
    # CONFIG_PACKAGE_luci-app-accesscontrol is not set
    # CONFIG_PACKAGE_luci-app-ddns is not set
    # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
    # CONFIG_PACKAGE_luci-app-pptp-server is not set
    # CONFIG_PACKAGE_luci-app-qbittorrent is not set
    # CONFIG_PACKAGE_luci-app-unblockmusic is not set
    # CONFIG_PACKAGE_luci-app-unblockneteasemusic-mini is not set
    # CONFIG_PACKAGE_luci-app-vlmcsd is not set
    # CONFIG_PACKAGE_luci-app-wol is not set
    # CONFIG_PACKAGE_luci-app-xlnetacc is not set
    # CONFIG_PACKAGE_luci-app-zerotier is not set
    # CONFIG_PACKAGE_luci-app-shadowsocks-libev is not set
    # CONFIG_PACKAGE_luci-app-v2ray-server is not set
    # CONFIG_UnblockNeteaseMusic_Go is not set
    # CONFIG_UnblockNeteaseMusic_NodeJS is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray_plugin is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray is not set
    # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan is not set
    # CONFIG_PACKAGE_luci-app-music-remote-center is not set
    EOF
    # 
    # ========================固件定制部分结束========================
    # 
    
    echo 'Generate configuration file'
    # 对比配置文件：
    cd /home/gitlab-runner/lede
    sed -i 's/^[ \t]*//g' ./.config
    make defconfig
    
    echo 'Make Clean'
    make clean
    
    echo 'Make download'
    make download -j1
    echo 'Compile firmware'
    make -j1
    
    echo 'Assemble artifact'
    # build pass and save
    ## config
    cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## phicomm_k3
    cp /home/gitlab-runner/lede/bin/targets/bcm53xx/generic/openwrt-bcm53xx-phicomm-k3-squashfs.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-bcm53xx-phicomm-k3-squashfs.trx
    ## remove git file
    cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
    rm .gitignore
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-k3"
    expire_in: 6 months
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
  # disable artifact passing
  dependencies: []
