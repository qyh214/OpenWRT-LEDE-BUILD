# CI type:shell
# https://github.com/coolsnowwolf/lede
# base
# ubuntu 16.04 x64 
# sudo apt-get update 
# sudo apt-get install build-essential asciidoc binutils 
# bzip2 gawk gettext git libncurses5-dev libz-dev patch 
# unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion 
# flex uglifyjs git-core gcc-multilib p7zip p7zip-full 
# msmtp libssl-dev texinfo libglib2.0-dev
#
# git clone url
# /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild

stages:
  - basebuild
  - ipq40xxbuild
  #- ipq806xbuild
  
build_jobbase:
  stage: basebuild
  tags: 
  - shell
  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
    #- cd /home/gitlab-runner/lede
    #- git pull
    #- ./scripts/feeds update -a
    #- ./scripts/feeds install -a
    # create bin in git clone url(test)
    #- cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
    #- mkdir bin
    
build_jobipq40xx:
  stage: ipq40xxbuild
  tags: 
  - shell
  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
    #- cd /home/gitlab-runner/lede
    #- git pull
    #- ./scripts/feeds update -a
    #- ./scripts/feeds install -a
    # config copy
    #- cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/ipq40xx.config /home/gitlab-runner/lede/.config
    #- make menuconfig(error)/make defconfig(compare with git)
    #- make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    #- make -j1
    # build pass
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
    - mkdir bin
    # copy bin
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## asus_rt-ac58u
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-squashfs-flash-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-squashfs-flash-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-ac58u-squashfs-sysupgrade.tar
    ## asus_rt-acrh17
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-squashfs-flash-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xx-asus_rt-acrh17-squashfs-flash-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq40xx/generic/openwrt-ipq40xx-asus_rt-acrh17-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq40xxx-asus_rt-acrh17-squashfs-sysupgrade.tar
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-ipq40xx"
    expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin

#build_jobipq806x:
#  stage: ipq806xbuild
#  tags: 
#  - shell
#  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    # update code
#    - cd /home/gitlab-runner/lede
    #- git pull
    #- ./scripts/feeds update -a
    #- ./scripts/feeds install -a
    # config copy
#    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/ipq806x.config /home/gitlab-runner/lede/.config
    #- make menuconfig(error)/make defconfig(compare with git)
#    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
#    - make -j1
    # build pass
    #- cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
    #- mkdir bin
    # copy bin
    ## config
#    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## netgear_r7800
#    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-factory.img /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-factory.img
#    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-netgear_r7800-squashfs-sysupgrade.bin
#  artifacts:
#    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router-ipq806x"
#    expire_in: 2 weeks
#    paths:
#      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin
