# gitlab-runner home
# todo:with lede updatetime to build
build_job:
  stage: build
  tags: 
  - shell
  script:
    # clean build
    #- cd /home/gitlab-runner/
    #- rm -R lede
    #- git clone https://github.com/coolsnowwolf/lede.git
    - cd /home/gitlab-runner/lede
    # update code
    - git pull
    - ./scripts/feeds update -a
    - ./scripts/feeds install -a 
    # config copy
    - cp /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/.config /home/gitlab-runner/lede/.config
    #- make menuconfig(error)/make defconfig(compare with git)
    - make defconfig
    #- export FORCE_UNSAFE_CONFIGURE=1 && make -j4 V=s
    - make -j1
    # build pass
    - cd /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild
    - mkdir bin
    # copy bin
    ## config
    - cp /home/gitlab-runner/lede/.config /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/.config
    ## r7800
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-r7800-squashfs-factory.img /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-r7800-squashfs-factory.img
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-R7800-squashfs-sysupgrade.bin /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-R7800-squashfs-sysupgrade.bin
    ## asus_rt-ac58u
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-asus_rt-ac58u-squashfs-flash-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-asus_rt-ac58u-squashfs-flash-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-asus_rt-ac58u-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-asus_rt-ac58u-squashfs-sysupgrade.tar
    ## asus_rt-acrh17
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-asus_rt-acrh17-squashfs-flash-factory.trx /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-asus_rt-acrh17-squashfs-flash-factory.trx
    - cp /home/gitlab-runner/lede/bin/targets/ipq806x/generic/openwrt-ipq806x-asus_rt-acrh17-squashfs-sysupgrade.tar /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin/`date   +%Y%m%d`-$CI_JOB_ID-openwrt-ipq806x-asus_rt-acrh17-squashfs-sysupgrade.tar
  artifacts:
    name: "`date   +%Y%m%d`-$CI_JOB_ID-openwrt-router"
    expire_in: 2 weeks
    paths:
      - /home/gitlab-runner/builds/b5d89257/0/shihuang/routerbuild/bin